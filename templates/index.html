<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Realtime Restaurant Floorplan</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
  :root {
    --bg: #f7f7f7;
    --card: #fff;
    --accent: #e6f0ff;
    --billed: #90ee90;
  }
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: var(--bg);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  .hidden { display: none !important; }
  .login-container {
    display: flex;
    justify-content: center;
    align-items: center;
    flex: 1;
  }
  .login-box {
    background: var(--card);
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    width: 90%;
    max-width: 320px;
  }
  .topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 16px;
    background: var(--card);
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  }
  .container {
    display: flex;
    gap: 12px;
    padding: 12px;
    align-items: flex-start;
  }
  .tables-container {
    flex: 1;
    background: var(--card);
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    padding: 10px;
  }
  .tables-wrapper {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 100%;
  }
  .tables-row {
    display: grid;
    width: 100%;
    grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
    gap: 10px;
  }
  .table {
    background: var(--accent);
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 8px;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    min-height: 90px;
    user-select: none;
  }
  .table.billed { background: var(--billed); }
  .capacity { font-size: 12px; color: #444; }
  .number { font-size: 20px; font-weight: 700; margin: 6px 0; }
  .timer { font-size: 12px; color: #333; }
  .floating-panel {
    width: 320px;
    max-width: 40%;
    background: var(--card);
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    height: fit-content;
  }
  .floating-panel h3 { margin: 0 0 8px 0; }
  #statusList div { margin-bottom: 6px; }
  #clearedList div { cursor: pointer; margin-bottom: 6px; color: #333; }
  button {
    background: #1976d2;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
  }
  button.secondary { background: #555; }
  .small { padding: 6px 8px; font-size: 13px; }
  @media (max-width: 900px) {
    .container { flex-direction: column; }
    .floating-panel {
      width: 100%;
      max-width: none;
      border-radius: 6px;
      margin-top: 10px;
    }
  }
  @media (max-width: 480px) {
    .tables-container { width: 100%; }
    .tables-row {
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap: 8px;
    }
    .table { min-height: 60px; padding: 6px; }
    .number { font-size: 16px; }
    .capacity, .timer { font-size: 11px; }
  }
</style>
</head>
<body>
<div class="topbar">
  <strong>Realtime Floorplan</strong>
  <button id="logoutBtn" class="small">Logout</button>
</div>

<div class="login-container" id="loginScreen">
  <div class="login-box">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username" style="width:100%"/><br/><br/>
    <input type="password" id="password" placeholder="Password" style="width:100%"/><br/><br/>
    <button id="loginBtn">Sign In</button>
    <div id="loginError" style="color:red;margin-top:8px;"></div>
  </div>
</div>

<div id="mainContent" class="hidden">
  <div class="container">
    <div class="tables-container">
      <div class="tables-wrapper">
        <div class="tables-row" id="row1"></div>
        <div class="tables-row" id="row2"></div>
        <div class="tables-row" id="row3"></div>
      </div>
    </div>
    <div class="floating-panel">
      <h3>Billed Tables</h3>
      <div id="statusList"></div>
      <h4>Recently Cleared</h4>
      <div id="clearedList"></div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button id="resetBtn" class="small secondary">Reset All</button>
      </div>
    </div>
  </div>
</div>

<script>
const socket = io();
let tables = {};
let timers = {};

function loginSuccess() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('mainContent').classList.remove('hidden');
}

document.getElementById('loginBtn').addEventListener('click', () => {
  if (username.value === 'admin' && password.value === '1234') {
    localStorage.setItem('loggedIn', 'true');
    loginSuccess();
  } else {
    loginError.textContent = 'Invalid credentials';
  }
});
if (localStorage.getItem('loggedIn') === 'true') loginSuccess();

document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.removeItem('loggedIn');
  location.reload();
});

function createTableEl(t) {
  const el = document.createElement('div');
  el.className = 'table' + (t.billed ? ' billed' : '');
  el.innerHTML = `
    <div class="capacity">${t.capacity} pac</div>
    <div class="number">${t.id}</div>
    <div class="timer" id="timer-${t.id}">${formatTime(t.start)}</div>`;
  el.addEventListener('click', () => {
    if (!t.billed) socket.emit('start_table', {id: t.id});
    else socket.emit('clear_table', {id: t.id});
  });
  return el;
}

function formatTime(start) {
  if (!start) return '';
  const diff = Date.now() - start;
  const m = Math.floor(diff / 60000);
  const s = Math.floor((diff % 60000) / 1000);
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function updateTimer(id) {
  const t = tables[id];
  const el = document.getElementById(`timer-${id}`);
  if (el) el.textContent = formatTime(t.start);
}

function renderAllTables() {
  const rows = {
    row1: [1,2,3,4,5,6,7,8],
    row2: [9,10,11,12,14],
    row3: [15,16,18,19,20,21,22]
  };
  for (let r in rows) {
    const rowDiv = document.getElementById(r);
    rowDiv.innerHTML = '';
    rows[r].forEach(id => {
      if (tables[id]) rowDiv.appendChild(createTableEl(tables[id]));
    });
  }
  renderStatus();
}

function renderStatus() {
  statusList.innerHTML = '';
  Object.values(tables).filter(t => t.billed).forEach(t => {
    const div = document.createElement('div');
    div.textContent = `Table ${t.id} (${t.capacity} pac)`;
    statusList.appendChild(div);
  });
}

function renderCleared(list) {
  clearedList.innerHTML = '';
  list.forEach(item => {
    const div = document.createElement('div');
    div.textContent = item;
    div.addEventListener('click', () => socket.emit('remove_cleared_item', item));
    clearedList.appendChild(div);
  });
}

socket.on('init', data => {
  tables = {};
  for (let k in data.tables) tables[k] = data.tables[k];
  renderAllTables();
  renderCleared(data.recentCleared);
  setInterval(() => Object.keys(tables).forEach(updateTimer), 1000);
});

socket.on('tables_update', data => {
  for (let k in data.tables) tables[k] = data.tables[k];
  Object.keys(data.tables).forEach(id => {
    const el = document.querySelector(`.table .number:contains("${id}")`);
    // Patch update instead of full re-render
    renderAllTables();
  });
  if (data.recentCleared) renderCleared(data.recentCleared);
});

socket.on('recently_cleared_update', renderCleared);

socket.on('full_reset', data => {
  tables = {};
  for (let k in data.tables) tables[k] = data.tables[k];
  renderAllTables();
  renderCleared(data.recentCleared);
});

document.getElementById('resetBtn').addEventListener('click', () => {
  if (confirm('Reset all tables?')) socket.emit('reset_all');
});
</script>
</body>
</html>
